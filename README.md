# SQL Database copier (cpdb)

Копирование баз данных 1C / MS SQL и развертывание на целевой системе.


| Возможные команды ||
|-|-|
| **help** | - Вывод справки по параметрам |
| **backup** | - Создание резервной копии базы MS SQL |
| **restore** | - Восстановление базы MS SQL из резервной копии |
| **dumpib** | - Выгрузить информационную базу в файл |
| **restoreib** | - Загрузить информационную базу из файла |
| **putyadisk** | - Помещение файла на Yandex-Диск |
| **getyadisk** | - Получение файла из Yandex-Диска |
| **split** | - Разделить файл на части (используется 7-Zip) |
| **merge** | - Собрать файл из частей (используется 7-Zip) |
| **uconstorage** | - Отключить информационную базу от хранилища конфигураций |
| **constorage** | - Подключить информационную базу к хранилищу конфигураций |

Для подсказки по конкретной команде наберите help <команда>

## backup - Создание резервной копии базы MS SQL

| Параметры: ||
|-|-|
| **-sql-srvr** | - Адрес сервера MS SQL |
| **-sql-db** | - Имя базы для восстановления |
| **-sql-user** | - Пользователь сервера |
| **-sql-pwd** | - Пароль пользователя сервера |
| **-bak-path** | - Путь к резервной копии |

#### Пример:
```
cpdb backup -sql-srvr MySQLName MyDatabase -sql-user sa -sql-pwd 12345 -bak-path "d:\MSSQL\Backup\MyDatabase_copy.bak"
```

## restore - Восстановление базы MS SQL из резервной копии

| Параметры: ||
|-|-|
| **-sql-srvr** | - Адрес сервера MS SQL |
| **-sql-db** | - Имя базы для восстановления |
| **-sql-user** | - Пользователь сервера |
| **-sql-pwd** | - Пароль пользователя сервера |
| **-bak-path** | - Путь к резервной копии |
| **-create-db** | - Создать базу в случае отсутствия |
| **-db-owner** | - Имя владельца базы после восстановления |
| **-shrink-db** | - Сжать базу после восстановления |
| **-db-bakname** | - Имя базы в файле резервной копии |
| **-db-path** | - Путь к каталогу файлов данных базы после восстановления |
| **-db-logpath** | - Путь к каталогу файлов журнала после восстановления |
| **-delsource** | - Удалить файл резервной копии после восстановления | 

#### Пример:
```
cpdb restore -sql-srvr MyNewSQLServer -sql-db MyDatabase_copy -sql-user SQLUser -sql-pwd 123456 -bak-path "d:\data\MyBackUpfile.bak" -create-db -shrink-db -db-owner SQLdbo -db-bakname MyDatabase -db-path "d:\MSSQL\data" -db-logpath "e:\MSSQL\logs" -delsource
```

## dumpib - Выгрузить информационную базу в файл

| Параметры: ||
|-|-|
| **-ib-path** | - Строка подключения к ИБ |
| **-ib-user** | - Пользователь ИБ |
| **-ib-pwd** | - Пароль пользователя ИБ |
| **-dt-path** | - Путь к файлу для выгрузки ИБ |
| **-uccode** | - Ключ разрешения запуска ИБ |
| **-v8version** | - Версия платформы 1С |

#### Пример:
```
cpdb dumpib -ib-path "/FD:/data/MyDatabase" -dt-path "d:\data\1Cv8.dt" -ib-user Администратор -ib-pwd 123456 -v8version 8.3.8 -uccode 1234
```

## restoreib - Загрузить информационную базу из файла

| Параметры: ||
|-|-|
| **-ib-path** | - Строка подключения к ИБ |
| **-ib-user** | - Пользователь ИБ |
| **-ib-pwd** | - Пароль пользователя ИБ |
| **-dt-path** | - Путь к файлу для загрузки в ИБ |
| **-delsource** | - Удалить файл после загрузки |
| **-uccode** | - Ключ разрешения запуска ИБ |
| **-v8version** | - Версия платформы 1С |

#### Пример:
```
cpdb restoreib -ib-path "/FD:/data/MyDatabase" -dt-path "d:\data\1Cv8.dt" -ib-user Администратор -ib-pwd 123456 -v8version 8.3.8 -uccode 1234 -delsource
```

## putyadisk - Помещение файла на Yandex-Диск

| Параметры: ||
|-|-|
| **-file** | - Путь к локальному файлу для помещения на Yandex-Диск |
| **-list** | - Путь к локальному файлу со списком файлов, которые будут помещены на Yandex-Диск (параметр -file игнорируется) |
| **-ya-token** | - Token авторизации |
| **-ya-path** | - Путь к каталогу на Yandex-Диск, куда помещать загружаемые файлы |
| **-check-hash** | - (TBE) Проверять соответствие хешей скопированных файлов. Работает только в том случае, когда имеется файл <имяархива>.hash с MD5-хешами частей файлов (формируется командой split) |
| **-delsource** | - Удалить исходные файлы после отправки |

#### Пример:
```
cpdb putyadisk -file "d:\MSSQL\Backup\MyDatabase_copy.bak" -ya-token XXXXXXXXXXXXXXXXXXXXXXXXXXXXX -ya-path "/transfer/MyDatabase_copy.bak" -delsource
```
```
cpdb putyadisk -list "d:\MSSQL\Backup\MyDatabase_copy.split" -ya-token XXXXXXXXXXXXXXXXXXXXXXXXXXXXX -ya-path "/transfer/MyDatabase_copy.bak" -delsource

```


## getyadisk  - Получение файла из Yandex-Диска

### Параметры:

| Параметры: ||
|-|-|
| **-path** | - Путь к локальному каталогу для сохранения загруженных файлов|
| **-ya-token** | - Token авторизации |
| **-ya-file** | - Путь к файлу на Yandex-Диск для загрузки |
| **-ya-list** | - Путь к файлу на Yandex-Диск со списком файлов, которые будут загружены (параметр -ya-file игнорируется) |
| **-delsource** | - Удалить файлы из Yandex-Диск после получения |

#### Пример:
```
cpdb getyadisk -path "d:\MSSQL\Backup\MyDatabase_copy.bak" -ya-token XXXXXXXXXXXXXXXXXXXXXXXXXXXXX -ya-file "/transfer/MyDatabase_copy.bak" -delsource
```
```
cpdb getyadisk -path "d:\MSSQL\Backup\MyDatabase_copy.bak" -ya-token XXXXXXXXXXXXXXXXXXXXXXXXXXXXX -ya-list "/transfer/MyDatabase_copy.split" -delsource
```

## uconstorage - Отключить информационную базу от хранилища конфигурации

### Параметры:

* <СтрокаПодключения> - Строка подключения к ИБ
* -db-user            - Пользователь ИБ
* -db-pwd             - Пароль пользователя ИБ
* -v8version          - Маска версии платформы 1С
* -uccode             - Ключ разрешения запуска ИБ

```
cpdb uconstorage "/FD:/data/MyDatabase" -db-user Администратор -db-pwd 123456 -v8version 8.3.8 -uccode 1234
```

## constorage - Подключить информационую базу к хранилищу конфигурации

### Параметры:

* <СтрокаПодключения> - Строка подключения к ИБ
* <АдресХранилища>    - Адрес хранилища конфигурации
* -db-user            - Пользователь ИБ
* -db-pwd             - Пароль пользователя ИБ
* -storage-user       - Пользователь хранилища конфигурации
* -storage-pwd        - Пароль пользователя хранилища конфигурации
| **-v8version** | - Версия платформы 1С |
* -uccode             - Ключ разрешения запуска ИБ

```
cpdb constorage "/FD:/data/MyDatabase" "tcp://MyServer/MyRepository" -db-user Администратор -db-pwd 123456 -storage-user MyDatabase_usr1 -storage-pwd 123456 -v8version 8.3.8 -uccode 1234
```

## split - Разбить файл на части

### Параметры

* <ПутьКФайлу> - Путь к локальному файлу для архивации/разбиения
* -v <Размер>{<g>,<m>,<b>}  - размер порции (по умолчанию - 50 Мб)
* -delsource   - Удалить исходный файл после разбиения
* -hash        - Формировать файл с хешами MD5 частей файла. Файл будет иметь имя <ИмяАрхива>.hash

#### Пример:
```
cpdb split "d:\MSSQL\Backup\MyDatabase_copy.bak" -v 40m -delsource
```
В результате будет создан текстовый файл MyDatabase_copy.split, содержащий имена файлов частей. Этот файл будет создан в том же каталоге, что и исходный файл

## merge - Соединить файл из частей

### Параметры

## Использование c Jenkins
В jenkinsfile описан конвейер, выполняющий следующий сценарий:
* Создание резервной копии указанной базы на системе-источнике
* Разбиение резервной копии на части (используется 7-Zip)
* Копирование частей файла на Yandex-Диск (в указанный каталог)
* Получение файла резервной копии из Yandex-Диск на системе-приемнике
* Восстановление указанной базы из резервной копии
* Подключает базу к хранилищу конфигурации

### Переменные окружения конвейера

* src_db_cred         - Идентификатор credentials для доступа к MS SQL в системе, где расположена база-источник
* src_agent_label     - Метка агента Jenkins в системе, где расположена база-источник
* src_server_name     - Имя сервера MS SQL в системе-источнике
* src_db_name         - Имя базы-источника
* src_bak_path        - Путь к файлу резервной копии в системе-источнике
* src_split_path      - Путь к split-файлу в системе-источнике

* storage_token       - Token для доступа к Yandex-Диску
* storage_path        - Путь к файлу на Yandex-Диск для передачи в систему-приемник

* dst_db_cred         - Идентификатор credentials для доступа к MS SQL в системе-приемнике
* dst_agent_label     - Метка агента Jenkins в системе, где расположена база-приемник
* dst_bak_path        - Путь к файлу резервной копии в системе-приемнике, в который будет загружен файл из Yandex-Диска
* dst_server_name     - Имя сервера MS SQL в системе-приемнике
* dst_db_name         - Имя базы-приемника
* dst_dbo             - Имя пользователя-владельца базы в системе-приемнике (dbowner)
* dst_db_path         - Путь к каталогу размещения файлов данных базы-приемника
* dst_log_path        - Путь к каталогу размещения файлов журнала базы-приемника

* dst_ib_agent_label  - Метка агента Jenkins в системе, где выполняется подключение к хранилищу конфигурации
* dst_ib_con_string   - Строка подключения к информационной базе, подключаемой к хранилищу
* dst_ib_cred         - Идентификатор credentials для доступа к информационной базе
* dst_ib_storage_adr  - Адрес хранилища конфигурации
* dst_ib_storage_cred - Идентификатор credentials для подключения к хранилищу конфигурации
